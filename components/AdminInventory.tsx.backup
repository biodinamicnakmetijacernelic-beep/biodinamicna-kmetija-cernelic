
import React, { useState, useRef, useEffect } from 'react';
import { X, Save, Search, RefreshCw, ShoppingBag, ClipboardList, Settings, Bell, Image as ImageIcon, Upload, Trash2, Pencil, ArrowLeft, AlertTriangle, Plus, Lock, Send, Eye, EyeOff, FileText, Type, Video } from 'lucide-react';
import { GalleryItem, PreOrderItem, NewsItem, VideoGalleryItem, Order } from '../types';
import { uploadImageToSanity, fetchProducts, updateProductStatus, createProduct, updateProduct, deleteProduct, createNewsPost, fetchAllNews, updateNewsPost, deleteNewsPost, fetchVideoGallery, createVideo, updateVideo, deleteVideo, fetchOrders, updateOrderStatus } from '../sanityClient';
import { sendOrderStatusUpdateEmail } from '../utils/emailService';
import { createClient } from '@sanity/client';
import { sanityConfig } from '../sanityConfig';

// Order management

interface AdminProps {
  onClose: () => void;
  currentImages?: GalleryItem[];
  onAddImage?: (img: GalleryItem) => void;
  onDeleteImage?: (id: string) => void;
}

interface PendingUpload {
  file: File;
  src: string;
  description: string;
}

interface NewsBlock {
  id: string;
  type: 'text' | 'image';
  content?: string;
  file?: File;
  preview?: string;
}

const AdminInventory: React.FC<AdminProps> = ({ onClose, currentImages = [], onAddImage, onDeleteImage }) => {
  const [activeTab, setActiveTab] = useState<'inventory' | 'orders' | 'gallery' | 'news' | 'videos' | 'settings'>('inventory');

  // Settings / API Token State
  const [sanityToken, setSanityToken] = useState(localStorage.getItem('sanity_token') || 'skfLb49oZf7DkswLGeSd8OgU4lrwWApK141Xcd0AOoeeM8gROXL045ZlHcWB0tgfQc4foFr0M72H95j7NwPdBqbb2w8ut4cXqVfhrPGExcUyatX6WNdk31jx1R4g3SBAeGIlUhRNFJfCvBQw5hIgHQx6negfr5annw1QeQTgH6CbZBAaQFqw');
  const [showToken, setShowToken] = useState(false);

  // Inventory State
  const [products, setProducts] = useState<PreOrderItem[]>([]);
  const [isLoadingProducts, setIsLoadingProducts] = useState(false);
  const [connectionError, setConnectionError] = useState(false);
  const [filter, setFilter] = useState<'all' | 'fresh' | 'dry'>('all');
  const [searchTerm, setSearchTerm] = useState('');

  // Inventory CRUD State
  const [isEditing, setIsEditing] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editForm, setEditForm] = useState({ name: '', price: '', unit: '', category: 'fresh', status: 'available' });
  const [editImageFile, setEditImageFile] = useState<File | null>(null);
  const [editImagePreview, setEditImagePreview] = useState<string | null>(null);
  const editImageRef = useRef<HTMLInputElement>(null);

  // Orders State
  const [orders, setOrders] = useState<Order[]>([]);
  const [isLoadingOrders, setIsLoadingOrders] = useState(false);
  const [notification, setNotification] = useState<string | null>(null);

  // Gallery Upload State
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [pendingUploads, setPendingUploads] = useState<PendingUpload[]>([]);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);

  // News State
  const [posts, setPosts] = useState<NewsItem[]>([]);
  const [isLoadingPosts, setIsLoadingPosts] = useState(false);
  const [newsForm, setNewsForm] = useState({ title: '', date: new Date().toISOString().split('T')[0] });
  const [newsImageFile, setNewsImageFile] = useState<File | null>(null);
  const [newsImagePreview, setNewsImagePreview] = useState<string | null>(null);
  const newsImageRef = useRef<HTMLInputElement>(null);

  // News Editing State
  const [isEditingNews, setIsEditingNews] = useState(false);
  const [editingNewsId, setEditingNewsId] = useState<string | null>(null);

  // News Blocks State (Rich Editor)
  const [newsBlocks, setNewsBlocks] = useState<NewsBlock[]>([
    { id: '1', type: 'text', content: '' }
  ]);

  // Video Gallery State
  const [videos, setVideos] = useState<VideoGalleryItem[]>([]);
  const [isLoadingVideos, setIsLoadingVideos] = useState(false);
  const [isEditingVideo, setIsEditingVideo] = useState(false);
  const [editingVideoId, setEditingVideoId] = useState<string | null>(null);
  const [videoForm, setVideoForm] = useState({ title: '', videoId: '', category: '' });

  // --- Initialize ---
  useEffect(() => {
    const savedToken = localStorage.getItem('sanity_token');
    if (savedToken) setSanityToken(savedToken);
    loadInventory();
  }, []);

  useEffect(() => {
    if (activeTab === 'videos') {
      loadVideos();
    } else if (activeTab === 'orders') {
      console.log("üîÑ Loading orders tab...");
      loadOrders().catch(error => {
        console.error("‚ùå Failed to load orders in useEffect:", error);
        setOrders([]); // Set empty array to prevent blank screen
        setIsLoadingOrders(false);
      });
    }
  }, [activeTab]);

const loadInventory = async () => {
  setIsLoadingProducts(true);
  setConnectionError(false);
  try {
    const liveProducts = await fetchProducts();
    setProducts(liveProducts);
  } catch (e) {
    console.error("Failed to load inventory:", e);
    setConnectionError(true);
    setProducts([]);
  }
  setIsLoadingProducts(false);
};

const loadPosts = async () => {
  setIsLoadingPosts(true);
  try {
    const allPosts = await fetchAllNews();
    setPosts(allPosts);
  } catch (e) {
    console.error("Failed to load posts:", e);
    setPosts([]);
  }
  setIsLoadingPosts(false);
};

const loadVideos = async () => {
  setIsLoadingVideos(true);
  try {
    const data = await fetchVideoGallery();
    setVideos(data);
  } catch (error) {
    console.error("Failed to load videos:", error);
  } finally {
    setIsLoadingVideos(false);
  }
};

const loadOrders = async () => {
  setIsLoadingOrders(true);
  try {
    const token = localStorage.getItem('sanity_token');
    console.log("üîç Loading orders - Token exists:", !!token);
    console.log("üîç Token preview:", token ? "***" + token.slice(-4) : "NO TOKEN");
    console.log("üîç Current localStorage keys:", Object.keys(localStorage));

    if (token) {
      console.log("üîç Calling fetchOrders with token...");
      const data = await fetchOrders(token);
      console.log("‚úÖ Fetched orders data:", data);
      console.log("‚úÖ Orders count:", data ? data.length : "undefined");

      // Ensure we always set an array to prevent blank screen
      const ordersArray = Array.isArray(data) ? data : [];
      setOrders(ordersArray);
    } else {
      console.warn("‚ùå No sanity token found for loading orders");
      console.log("üí° Please set the token in Settings tab first");
      setOrders([]); // Set empty array to prevent blank screen
    }
  } catch (error) {
    console.error("‚ùå Failed to load orders:", error);
    console.error("‚ùå Error details:", error.message);
    console.error("‚ùå Error stack:", error.stack);

    // Always set empty array on error to prevent blank screen
    setOrders([]);
  } finally {
    console.log("üèÅ loadOrders completed");
    setIsLoadingOrders(false);
  }
};

const handleOrderStatus = async (orderId: string, newStatus: string) => {
  try {
    const token = localStorage.getItem('sanity_token');
    if (!token) {
      alert('Manjka API token. Preverite nastavitve.');
      return;
    }

    // Find the current order to get its data for email
    const currentOrder = orders.find(order => order.id === orderId);
    if (!currentOrder) {
      alert('Naroƒçilo ni najdeno.');
      return;
    }

    const oldStatus = currentOrder.status;

    // Update order status in Sanity
    const success = await updateOrderStatus(orderId, newStatus, token);
    if (!success) {
      alert('Napaka pri posodabljanju statusa.');
      return;
    }

    // Send email notification to customer
    const emailOrderData = {
      ...currentOrder,
      status: newStatus as 'pending' | 'approved' | 'rejected' | 'completed'
    };

    // Send email asynchronously (don't block the UI)
    sendOrderStatusUpdateEmail(emailOrderData, oldStatus, newStatus).catch(emailError => {
      console.warn('Failed to send status update email:', emailError);
    });

    // Update local state
    setOrders(orders.map(order =>
      order.id === orderId ? { ...order, status: newStatus as any } : order
    ));

    // Show success notification
    setNotification(`‚úÖ Status naroƒçila posodobljen na "${newStatus === 'approved' ? 'Potrjeno' : newStatus === 'rejected' ? 'Zavrnjeno' : newStatus === 'completed' ? 'Zakljuƒçeno' : 'V obdelavi'}".`);
    setTimeout(() => setNotification(null), 3000);

  } catch (error) {
    console.error('Error updating order status:', error);
    alert('Napaka pri posodabljanju statusa naroƒçila.');
  }
};

const handleSaveToken = () => {
  localStorage.setItem('sanity_token', sanityToken);
  setNotification("üîë Povezava shranjena! Zdaj lahko nalagate slike.");
  setTimeout(() => setNotification(null), 3000);
};

// --- News Block Logic ---
const addTextBlock = () => {
  setNewsBlocks([...newsBlocks, { id: Date.now().toString(), type: 'text', content: '' }]);
};

const addImageBlock = () => {
  setNewsBlocks([...newsBlocks, { id: Date.now().toString(), type: 'image' }]);
};

const removeBlock = (id: string) => {
  setNewsBlocks(newsBlocks.filter(b => b.id !== id));
};

const updateBlockContent = (id: string, content: string) => {
  setNewsBlocks(newsBlocks.map(b => b.id === id ? { ...b, content } : b));
};

const handleBlockImageSelect = (id: string, file: File) => {
  const preview = URL.createObjectURL(file);
  setNewsBlocks(newsBlocks.map(b => b.id === id ? { ...b, file, preview } : b));
};

const handleNewsImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    setNewsImageFile(file);
    setNewsImagePreview(URL.createObjectURL(file));
  }
};

const startEditNews = (post: NewsItem) => {
  setEditingNewsId(post.id);
  setNewsForm({ title: post.title, date: post.publishedAt });
  setNewsImagePreview(post.image);
  setNewsImageFile(null);

  // Convert body back to blocks for editing
  const blocks: NewsBlock[] = [];
  if (Array.isArray(post.body)) {
    post.body.forEach((block: any, index: number) => {
      if (block._type === 'block') {
        blocks.push({
          id: block._key || `block-${index}`,
          type: 'text',
          content: block.children?.map((child: any) => child.text).join('') || ''
        });
      } else if (block._type === 'image') {
        blocks.push({
          id: block._key || `img-${index}`,
          type: 'image',
          preview: block.asset ? '' : undefined // We can't easily get the URL here
        });
      }
    });
  }
  setNewsBlocks(blocks.length > 0 ? blocks : [{ id: Date.now().toString(), type: 'text', content: '' }]);
  setIsEditingNews(true);
};

const handleSaveNews = async () => {
  if (!sanityToken) {
    setNotification("‚ö†Ô∏è Manjka API kljuƒç!");
    return;
  }
  if (!newsForm.title) {
    setNotification("‚ö†Ô∏è Naslov je obvezen.");
    return;
  }

  setIsUploading(true);
  try {
    // Prepare auth client for inline image uploads
    const authClient = createClient({
      ...sanityConfig,
      token: sanityToken,
      ignoreBrowserTokenWarning: true
    });

    const finalBody = [];

    // Process blocks
    for (const block of newsBlocks) {
      if (block.type === 'text' && block.content?.trim()) {
        finalBody.push({
          _type: 'block',
          _key: block.id,
          style: 'normal',
          children: [{
            _type: 'span',
            _key: `${block.id}-span`,
            text: block.content
          }]
        });
      } else if (block.type === 'image' && block.file) {
        // Upload inline image
        const asset = await authClient.assets.upload('image', block.file, { filename: block.file.name });
        finalBody.push({
          _type: 'image',
          _key: block.id,
          asset: { _type: 'reference', _ref: asset._id }
        });
      }
    }

    if (editingNewsId) {
      // Update existing post
      await updateNewsPost(editingNewsId, {
        title: newsForm.title,
        date: newsForm.date,
        body: finalBody
      }, newsImageFile, sanityToken);
      setNotification("‚úÖ Novica posodobljena!");
    } else {
      // Create new post
      await createNewsPost({
        title: newsForm.title,
        date: newsForm.date,
        body: finalBody
      }, newsImageFile, sanityToken);
      setNotification("‚úÖ Novica uspe≈°no objavljena!");
    }

    // Reset
    setNewsForm({ title: '', date: new Date().toISOString().split('T')[0] });
    setNewsImageFile(null);
    setNewsImagePreview(null);
    setNewsBlocks([{ id: Date.now().toString(), type: 'text', content: '' }]);
    setIsEditingNews(false);
    setEditingNewsId(null);

    loadPosts();
    setTimeout(() => setNotification(null), 3000);
  } catch (e) {
    console.error(e);
    setNotification("‚ùå Napaka pri shranjevanju.");
  } finally {
    setIsUploading(false);
    setTimeout(() => setNotification(null), 3000);
  }
};

const handleDeleteNews = async () => {
  if (!editingNewsId || !sanityToken) return;
  if (!confirm("Ste prepriƒçani, da ≈æelite izbrisati to novico?")) return;

  setIsUploading(true);
  try {
    await deleteNewsPost(editingNewsId, sanityToken);
    setNotification("üóëÔ∏è Novica izbrisana.");
    setIsEditingNews(false);
    setEditingNewsId(null);
    setNewsForm({ title: '', date: new Date().toISOString().split('T')[0] });
    setNewsImageFile(null);
    setNewsImagePreview(null);
    setNewsBlocks([{ id: Date.now().toString(), type: 'text', content: '' }]);
    loadPosts();
  } catch (e) {
    setNotification("‚ùå Napaka pri brisanju.");
  } finally {
    setIsUploading(false);
    setTimeout(() => setNotification(null), 3000);
  }
};

// --- Video Gallery Handlers ---
const startEditVideo = (video: VideoGalleryItem) => {
  setEditingVideoId(video.id);
  setVideoForm({ title: video.title, videoId: video.videoId, category: video.category || '' });
  setIsEditingVideo(true);
};

const handleSaveVideo = async () => {
  if (!sanityToken) {
    setNotification("‚ö†Ô∏è Manjka API kljuƒç!");
    return;
  }
  if (!videoForm.title || !videoForm.videoId) {
    setNotification("‚ö†Ô∏è Naslov in Video ID sta obvezna.");
    return;
  }

  setIsUploading(true);
  try {
    if (editingVideoId) {
      await updateVideo(editingVideoId, videoForm, sanityToken);
      setNotification("‚úÖ Video posodobljen!");
    } else {
      await createVideo(videoForm, sanityToken);
      setNotification("‚úÖ Nov video dodan!");
    }
    setIsEditingVideo(false);
    setEditingVideoId(null);
    setVideoForm({ title: '', videoId: '', category: '' });
    loadVideos();
  } catch (e) {
    setNotification("‚ùå Napaka pri shranjevanju.");
  } finally {
    setIsUploading(false);
    setTimeout(() => setNotification(null), 3000);
  }
};

// Util function for Slovenian status and color
const getProductStatusProps = (status: string) => {
  switch (status) {
    case 'available':
      return { label: 'na voljo', color: 'bg-green-500', text: 'text-green-600' };
    case 'sold-out':
      return { label: 'razprodano', color: 'bg-red-500', text: 'text-red-500' };
    case 'coming-soon':
      return { label: 'kmalu', color: 'bg-yellow-400', text: 'text-yellow-600' };
    default:
      return { label: status, color: 'bg-gray-300', text: 'text-gray-500' };
  }
};

const handleStatusToggle = async (e: React.MouseEvent, id: string, currentStatus: string) => {
  e.stopPropagation();
  // status cycle: available -> sold-out -> coming-soon -> available
  let nextStatus = '';
  if (currentStatus === 'available') nextStatus = 'sold-out';
  else if (currentStatus === 'sold-out') nextStatus = 'coming-soon';
  else nextStatus = 'available';
  setProducts(prev => prev.map(p => p.id === id ? { ...p, status: nextStatus as any } : p));

  if (sanityToken) {
    try {
      await updateProductStatus(id, nextStatus, sanityToken);
      setNotification('‚úÖ Status posodobljen!');
      setTimeout(() => setNotification(null), 2000);
    } catch (e) {
      setNotification('‚ùå Napaka pri shranjevanju.');
    }
  } else {
    setNotification('‚ö†Ô∏è Za shranjevanje potrebujete API Token.');
  }
};

const startAddProduct = () => {
  setEditingId(null);
  setEditForm({ name: '', price: '', unit: 'kg', category: 'fresh', status: 'available' });
  setEditImageFile(null);
  setEditImagePreview(null);
  setIsEditing(true);
};

const startEditProduct = (product: PreOrderItem) => {
  setEditingId(product.id);
  setEditForm({
    name: product.name,
    price: product.price.toString(),
    unit: product.unit,
    category: product.category,
    status: product.status
  });
  setEditImageFile(null);
  setEditImagePreview(product.image);
  setIsEditing(true);
};

const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    setEditImageFile(file);
    setEditImagePreview(URL.createObjectURL(file));
  }
};

const handleSaveProduct = async () => {
  if (!sanityToken) { setNotification("‚ö†Ô∏è Manjka API kljuƒç!"); return; }
  if (!editForm.name || !editForm.price) { setNotification("‚ö†Ô∏è Ime in cena sta obvezna."); return; }

  setIsUploading(true);
  try {
    const priceNum = parseFloat(editForm.price.replace(',', '.'));
    if (editingId) {
      await updateProduct(editingId, { ...editForm, price: priceNum }, editImageFile, sanityToken);
      setNotification("‚úÖ Izdelek posodobljen!");
    } else {
      await createProduct({ ...editForm, price: priceNum }, editImageFile, sanityToken);
      setNotification("‚úÖ Nov izdelek ustvarjen!");
    }
    setIsEditing(false);
    loadInventory();
  } catch (e) {
    setNotification("‚ùå Napaka pri shranjevanju.");
  } finally {
    setIsUploading(false);
    setTimeout(() => setNotification(null), 3000);
  }
};

const handleDeleteProduct = async () => {
  if (!editingId || !sanityToken) return;
  if (!confirm("Ste prepriƒçani, da ≈æelite izbrisati ta izdelek?")) return;
  setIsUploading(true);
  try {
    await deleteProduct(editingId, sanityToken);
    setNotification("üóëÔ∏è Izdelek izbrisan.");
    setIsEditing(false);
    loadInventory();
  } catch (e) {
    setNotification("‚ùå Napaka pri brisanju.");
  } finally {
    setIsUploading(false);
    setTimeout(() => setNotification(null), 3000);
  }
};

const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
  const files = event.target.files;
  if (files && files.length > 0) {
    const newUploads: PendingUpload[] = [];
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const src = URL.createObjectURL(file);
      newUploads.push({ file, src, description: '' });
    }
    setPendingUploads(prev => [...prev, ...newUploads]);
    if (fileInputRef.current) fileInputRef.current.value = '';
  }
};

const handleUploadConfirm = async () => {
  if (!sanityToken) { setNotification("‚ö†Ô∏è Manjka API kljuƒç!"); setActiveTab('settings'); return; }
  if (pendingUploads.length > 0) {
    setIsUploading(true);
    setUploadProgress(0);
    const today = new Date().toLocaleDateString('sl-SI');
    let successCount = 0;
    try {
      for (let i = 0; i < pendingUploads.length; i++) {
        const item = pendingUploads[i];
        await uploadImageToSanity(item.file, { title: item.description || 'Utrinek', description: item.description, date: today }, sanityToken);
        successCount++;
        setUploadProgress(((i + 1) / pendingUploads.length) * 100);
      }
      setNotification(`‚úÖ Uspe≈°no nalo≈æeno: ${successCount} slik! Osve≈æite stran.`);
      setPendingUploads([]);
      setTimeout(() => { window.location.reload(); }, 2000);
    } catch (error) {
      setNotification("‚ùå Napaka pri nalaganju.");
    } finally {
      setIsUploading(false);
      setTimeout(() => setNotification(null), 4000);
    }
  }
};

const filteredProducts = products.filter(p => {
  const productName = p.name || '';
  return (filter === 'all' || p.category === filter) && productName.toLowerCase().includes(searchTerm.toLowerCase());
});

return (
  <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/10 backdrop-blur-[5px] animate-in fade-in">
    <div className="relative w-full max-w-2xl md:max-w-3xl lg:max-w-4xl h-[95vh] bg-cream rounded-3xl shadow-2xl border border-black/10 flex flex-col overflow-hidden font-sans animate-in fade-in slide-in-from-bottom duration-350">

      {/* Header */}
      <div className="bg-white border-b border-black/5 px-6 py-4 flex items-center justify-between sticky top-0 z-20 safe-area-top shadow-sm rounded-t-3xl">
        <div className="flex flex-col">
          <span className="text-[10px] uppercase tracking-widest text-olive/50 font-bold">Kmetija ƒåerneliƒç</span>
          <div className="flex items-center gap-2">
            <h2 className="font-serif text-xl text-olive-dark">Upravljanje</h2>
            {!isLoadingProducts && (
              <div className={`px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${connectionError ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`}>
                {connectionError ? 'Napaka' : '≈Ωivo'}
              </div>
            )}
          </div>
        </div>
        <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">
          <X size={20} className="text-olive-dark" />
        </button>
      </div>

      {/* Tabs */}
      <div className="flex bg-white border-b border-black/5 overflow-x-auto">
        <button onClick={() => setActiveTab('inventory')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'inventory' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><ShoppingBag size={16} />Zaloga</button>
        <button onClick={() => setActiveTab('orders')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'orders' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><ClipboardList size={16} />Naroƒçila</button>
        <button onClick={() => setActiveTab('news')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'news' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><FileText size={16} />Novice</button>
        <button onClick={() => setActiveTab('videos')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'videos' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><Video size={16} />Video</button>
        <button onClick={() => setActiveTab('gallery')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'gallery' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><ImageIcon size={16} />Galerija</button>
        <button onClick={() => setActiveTab('settings')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'settings' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><Settings size={16} />Nastavitve</button>
      </div>

      {/* Notification Toast */}
      {notification && (
        <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-olive-dark text-white px-6 py-3 rounded-full shadow-xl z-50 animate-in fade-in slide-in-from-top-5 text-sm font-medium flex items-center gap-2 whitespace-nowrap">
          <Bell size={16} className="animate-bounce" />
          {notification}
        </div>
      )}

      {/* --- INVENTORY TAB --- */}
      {activeTab === 'inventory' && (
        <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar pb-24">
          {/* ... Inventory UI (Same as before, simplified for brevity) ... */}
          {!isEditing ? (
            <>
              <div className="flex justify-between items-center mb-2 px-1">
                <h3 className="font-serif text-lg text-olive-dark">Seznam Izdelkov</h3>
                <button onClick={startAddProduct} className="bg-olive text-white px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide flex items-center gap-2 shadow-md"><Plus size={16} /> Nov</button>
              </div>
              {filteredProducts.map((product) => (
                <div key={product.id} className="bg-white p-4 rounded-2xl border border-black/5 flex flex-col gap-3 shadow-sm">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <img src={product.image} className="w-12 h-12 rounded-lg object-cover bg-gray-50" />
                      <div>
                        <h4 className="font-serif text-lg text-olive-dark leading-none mb-1">{product.name}</h4>
                        <p className="text-xs text-olive/50 font-medium">{product.price.toFixed(2)}‚Ç¨ / {product.unit}</p>
                        <button
                          onClick={() => startEditProduct(product)}
                          className="inline-flex items-center gap-2 mt-2 px-3 py-1 text-xs font-semibold text-olive/90 bg-olive/10 border border-olive/10 rounded-xl shadow-sm hover:bg-olive/20 transition-colors"
                        >
                          <Pencil size={14} /> Uredi
                        </button>
                      </div>
                    </div>
                    <button onClick={(e) => handleStatusToggle(e, product.id, product.status)} className="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-full">
                      <span className={`text-[10px] uppercase font-bold ${getProductStatusProps(product.status).text}`}>{getProductStatusProps(product.status).label}</span>
                      <div className={`w-3 h-3 rounded-full ${getProductStatusProps(product.status).color}`} />
                    </button>
                  </div>
                </div>
              ))}
            </>
          ) : (
            <div className="bg-white rounded-3xl p-6 shadow-sm border border-black/5">
              <div className="flex items-center gap-2 mb-6 text-olive/50 cursor-pointer" onClick={() => setIsEditing(false)}><ArrowLeft size={16} /><span className="text-xs font-bold uppercase">Nazaj</span></div>
              <div className="space-y-4">
                {/* Simplified Image Input */}
                <input type="file" onChange={handleImageSelect} className="mb-4" />
                <input type="text" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3" value={editForm.name} onChange={e => setEditForm({ ...editForm, name: e.target.value })} placeholder="Ime Izdelka" />
                <div className="flex gap-2">
                  <input type="number" step="0.01" className="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3" value={editForm.price} onChange={e => setEditForm({ ...editForm, price: e.target.value })} placeholder="Cena" />
                  <select value={editForm.unit} onChange={e => setEditForm({ ...editForm, unit: e.target.value })} className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-gray-700">
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="kos">kos</option>
                    <option value="l">l</option>
                    <option value="pack">paket</option>
                  </select>
                </div>
                <div className="flex gap-2">
                  {editingId && <button onClick={handleDeleteProduct} className="p-4 bg-red-50 text-red-500 rounded-xl"><Trash2 size={20} /></button>}
                  <button onClick={handleSaveProduct} className="px-8 py-4 bg-olive text-white rounded-xl font-bold uppercase" style={{ minWidth: '120px' }} disabled={isUploading}>Shrani</button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* --- NEWS TAB (RICH EDITOR) --- */}
      {activeTab === 'news' && (
        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50 pb-24">
          {!sanityToken && (
            <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-2xl mb-6 text-sm flex items-center gap-3 cursor-pointer" onClick={() => setActiveTab('settings')}>
              <Lock size={20} />
              <div><p className="font-bold">Objavljanje onemogoƒçeno</p><p className="text-xs">V nastavitvah vnesite API Token.</p></div>
            </div>
          )}

          {!isEditingNews ? (
            <>
              {/* News List */}
              <div className="flex justify-between items-center mb-2 px-1">
                <h3 className="font-serif text-lg text-olive-dark">Objavljene Novice</h3>
                <button onClick={() => { setIsEditingNews(true); loadPosts(); }} className="bg-olive text-white px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide flex items-center gap-2 shadow-md"><Plus size={16} /> Nova</button>
              </div>

              {isLoadingPosts ? (
                <div className="text-center py-8 text-olive/50"><RefreshCw className="animate-spin mx-auto mb-2" size={24} /><p className="text-sm">Nalaganje...</p></div>
              ) : posts.length === 0 ? (
                <div className="bg-white rounded-3xl p-8 text-center text-olive/50"><FileText size={32} className="mx-auto mb-2" /><p className="text-sm">≈†e ni objavljenih novic</p></div>
              ) : (
                [...posts]
                  .sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime())
                  .map((post) => (
                    <div key={post.id} className="bg-white p-4 rounded-2xl border border-black/5 flex flex-col gap-2 shadow-sm">
                      <div className="flex items-start gap-4">
                        <div className="flex-1">
                          <h4 className="font-serif text-lg text-olive-dark leading-tight mb-1">{post.title}</h4>
                          <p className="text-xs text-olive/50 font-medium mb-1">{new Date(post.publishedAt).toLocaleDateString('sl-SI')}</p>
                          <button onClick={() => startEditNews(post)} className="inline-flex items-center gap-2 mt-1 px-3 py-1 text-xs font-semibold text-olive/90 bg-olive/10 border border-olive/10 rounded-xl shadow-sm hover:bg-olive/20 transition-colors">
                            <Pencil size={14} /> Uredi
                          </button>
                        </div>
                        {post.image && <img src={post.image} className="w-16 h-16 rounded-lg object-cover bg-gray-50" />}
                      </div>
                    </div>
                  ))
              )}
            </>
          ) : (
            <div className={`bg-white rounded-3xl p-6 shadow-sm border border-black/5 ${!sanityToken ? 'opacity-50 pointer-events-none' : ''}`}>
              <div className="flex items-center gap-2 mb-6 text-olive/50 cursor-pointer" onClick={() => { setIsEditingNews(false); setEditingNewsId(null); setNewsForm({ title: '', date: new Date().toISOString().split('T')[0] }); setNewsImageFile(null); setNewsImagePreview(null); setNewsBlocks([{ id: Date.now().toString(), type: 'text', content: '' }]); }}><ArrowLeft size={16} /><span className="text-xs font-bold uppercase">Nazaj</span></div>

              <h3 className="font-serif text-xl text-olive-dark mb-4">{editingNewsId ? 'Uredi Objavo' : 'Nova Objava'}</h3>

              <div className="space-y-4">
                {/* Main Header Image */}
                <div className="relative h-40 bg-gray-100 rounded-2xl overflow-hidden border-2 border-dashed border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" onClick={() => newsImageRef.current?.click()}>
                  {newsImagePreview ? (
                    <img src={newsImagePreview} className="w-full h-full object-cover" />
                  ) : (
                    <div className="flex flex-col items-center justify-center h-full text-olive/40">
                      <ImageIcon size={32} />
                      <span className="text-xs font-bold uppercase mt-2">Naslovna Slika</span>
                    </div>
                  )}
                  <input type="file" ref={newsImageRef} className="hidden" accept="image/*" onChange={handleNewsImageSelect} />
                </div>

                <input
                  type="text"
                  className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-terracotta font-serif text-lg"
                  value={newsForm.title}
                  onChange={e => setNewsForm({ ...newsForm, title: e.target.value })}
                  placeholder="Naslov Novice"
                />

                {/* Block Editor Area */}
                <div className="space-y-3">
                  <label className="text-xs font-bold uppercase text-olive/50 block">Vsebina</label>

                  {newsBlocks.map((block, index) => (
                    <div key={block.id} className="relative group">
                      {block.type === 'text' ? (
                        <textarea
                          className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-terracotta min-h-[100px] resize-y"
                          value={block.content}
                          onChange={e => updateBlockContent(block.id, e.target.value)}
                          placeholder="Napi≈°ite odstavek..."
                        />
                      ) : (
                        <div className="relative bg-gray-100 rounded-xl p-4 border-2 border-dashed border-gray-200 flex flex-col items-center justify-center">
                          {block.preview ? (
                            <img src={block.preview} className="max-h-40 rounded-lg object-contain" />
                          ) : (
                            <div className="text-center py-4">
                              <ImageIcon className="mx-auto text-olive/30 mb-2" />
                              <input type="file" accept="image/*" onChange={(e) => e.target.files?.[0] && handleBlockImageSelect(block.id, e.target.files[0])} className="text-xs text-olive/60" />
                            </div>
                          )}
                        </div>
                      )}

                      {/* Remove Block Button */}
                      {newsBlocks.length > 1 && (
                        <button onClick={() => removeBlock(block.id)} className="absolute -right-2 -top-2 bg-red-100 text-red-500 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-200">
                          <X size={14} />
                        </button>
                      )}
                    </div>
                  ))}

                  {/* Add Block Buttons */}
                  <div className="flex gap-2 pt-2">
                    <button onClick={addTextBlock} className="flex-1 py-2 border border-olive/20 rounded-xl text-olive/70 text-xs font-bold uppercase hover:bg-olive/5 flex items-center justify-center gap-2">
                      <Type size={14} /> Dodaj Besedilo
                    </button>
                    <button onClick={addImageBlock} className="flex-1 py-2 border border-olive/20 rounded-xl text-olive/70 text-xs font-bold uppercase hover:bg-olive/5 flex items-center justify-center gap-2">
                      <ImageIcon size={14} /> Dodaj Sliko
                    </button>
                  </div>
                </div>

                <div className="flex gap-2 mt-6">
                  {editingNewsId && <button onClick={handleDeleteNews} className="p-4 bg-red-50 text-red-500 rounded-xl"><Trash2 size={20} /></button>}
                  <button
                    onClick={handleSaveNews}
                    disabled={isUploading}
                    className="flex-1 bg-olive text-white py-4 rounded-2xl font-bold uppercase tracking-widest shadow-lg hover:bg-olive-dark transition-all flex items-center justify-center gap-2"
                  >
                    {isUploading ? <RefreshCw className="animate-spin" /> : <Send size={16} />}
                    {editingNewsId ? 'Posodobi' : 'Objavi'}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* ORDERS TAB */}
      {activeTab === 'orders' && (
        <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
          <div className="flex justify-between items-center">
            <div>
              <h2 className="font-serif text-3xl text-olive-dark mb-2">Upravljanje Naroƒçil</h2>
              <p className="text-olive/60">Pregled in urejanje prejetih povpra≈°evanj.</p>
            </div>
            <button
              onClick={loadOrders}
              className="p-3 bg-white rounded-full shadow-md hover:shadow-lg text-olive transition-all"
              title="Osve≈æi"
            >
              <RefreshCw size={20} className={isLoadingOrders ? "animate-spin" : ""} />
            </button>
          </div>

          {isLoadingOrders ? (
            <div className="text-center py-20">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-olive"></div>
              <p className="mt-4 text-olive/60">Nalaganje naroƒçil...</p>
            </div>
          ) : orders.length === 0 ? (
            <div className="bg-white rounded-[2rem] p-12 text-center border border-black/5 shadow-sm">
              <ClipboardList size={48} className="mx-auto text-olive/20 mb-4" />
              <h3 className="text-xl text-olive-dark font-serif mb-2">Ni novih naroƒçil</h3>
              <p className="text-olive/60">Trenutno ni nobenih oddanih povpra≈°evanj.</p>
            </div>
          ) : (
            <div className="grid gap-6">
              {(orders || []).map((order) => (
                <div key={order.id} className="bg-white rounded-[2rem] p-6 border border-black/5 shadow-sm hover:shadow-md transition-all">
                  <div className="flex flex-col md:flex-row justify-between gap-6">
                    {/* Order Header & Customer Info */}
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-4">
                        <span className="font-mono text-xs font-bold bg-gray-100 px-2 py-1 rounded text-gray-500">{order.orderNumber}</span>
                        <span className="text-xs text-olive/40 uppercase tracking-widest font-bold">
                          {new Date(order.createdAt).toLocaleString('sl-SI')}
                        </span>
                        <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest border ${order.status === 'pending' ? 'bg-yellow-50 text-yellow-600 border-yellow-200' :
                            order.status === 'approved' ? 'bg-green-50 text-green-600 border-green-200' :
                              order.status === 'rejected' ? 'bg-red-50 text-red-600 border-red-200' :
                                'bg-gray-50 text-gray-600 border-gray-200'
                          }`}>
                          {order.status === 'pending' ? 'V obdelavi' :
                            order.status === 'approved' ? 'Potrjeno' :
                              order.status === 'rejected' ? 'Zavrnjeno' : 'Zakljuƒçeno'}
                        </span>
                      </div>

                      <h3 className="font-serif text-xl text-olive-dark mb-1">{order.customer.name}</h3>
                      <div className="text-sm text-olive/60 space-y-1 mb-4">
                        <p className="flex items-center gap-2"><span className="w-4"><Send size={12} /></span> {order.customer.email}</p>
                        <p className="flex items-center gap-2"><span className="w-4"><Bell size={12} /></span> {order.customer.phone}</p>
                      </div>

                      {order.note && (
                        <div className="bg-cream/50 p-3 rounded-xl text-sm text-olive/80 italic border border-olive/5">
                          "{order.note}"
                        </div>
                      )}
                    </div>

                    {/* Order Items */}
                    <div className="flex-1 border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6">
                      <h4 className="text-xs font-bold uppercase tracking-widest text-olive/40 mb-3">Naroƒçeno</h4>
                      <div className="space-y-2 mb-4">
                        {order.items.map((item, idx) => (
                          <div key={idx} className="flex justify-between text-sm">
                            <span className="text-olive-dark">
                              <span className="font-bold text-terracotta mr-2">{item.quantity}x</span>
                              {item.name}
                            </span>
                            <span className="text-olive/60">{(item.price * item.quantity).toFixed(2)}‚Ç¨</span>
                          </div>
                        ))}
                      </div>
                      <div className="flex justify-between items-center pt-3 border-t border-gray-100">
                        <span className="font-bold text-olive-dark">Skupaj</span>
                        <span className="font-serif text-xl text-olive-dark">{order.total.toFixed(2)}‚Ç¨</span>
                      </div>
                    </div>

                    {/* Actions */}
                    <div className="flex flex-row md:flex-col justify-end gap-2 border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6 min-w-[140px]">
                      {order.status === 'pending' && (
                        <>
                          <button
                            onClick={() => handleOrderStatus(order.id, 'approved')}
                            className="flex-1 bg-green-50 text-green-700 hover:bg-green-100 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-colors flex items-center justify-center gap-2"
                          >
                            <Check size={14} /> Potrdi
                          </button>
                          <button
                            onClick={() => handleOrderStatus(order.id, 'rejected')}
                            className="flex-1 bg-red-50 text-red-700 hover:bg-red-100 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-colors flex items-center justify-center gap-2"
                          >
                            <X size={14} /> Zavrni
                          </button>
                        </>
                      )}
                      {order.status !== 'pending' && (
                        <div className="text-center text-xs text-olive/40 italic py-2">
                          Status urejen
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
          )}
        </div>
      )}

      {/* --- VIDEO GALLERY TAB --- */}
      {activeTab === 'videos' && (
        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50 pb-24">
          {!sanityToken && (
            <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-2xl mb-6 text-sm flex items-center gap-3 cursor-pointer" onClick={() => setActiveTab('settings')}>
              <Lock size={20} />
              <div><p className="font-bold">Upravljanje onemogoƒçeno</p><p className="text-xs">V nastavitvah vnesite API Token.</p></div>
            </div>
          )}

          {!isEditingVideo ? (
            <>
              {/* Video List */}
              <div className="flex justify-between items-center mb-2 px-1">
                <h3 className="font-serif text-lg text-olive-dark">Video Galerija</h3>
                <button onClick={() => { setIsEditingVideo(true); setEditingVideoId(null); setVideoForm({ title: '', videoId: '', category: '' }); }} className="bg-olive text-white px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide flex items-center gap-2 shadow-md"><Plus size={16} /> Dodaj Video</button>
              </div>

              {isLoadingVideos ? (
                <div className="text-center py-8 text-olive/50"><RefreshCw className="animate-spin mx-auto mb-2" size={24} /><p className="text-sm">Nalaganje...</p></div>
              ) : videos.length === 0 ? (
                <div className="bg-white rounded-3xl p-8 text-center text-olive/50"><Video size={32} className="mx-auto mb-2" /><p className="text-sm">≈†e ni dodanih videov</p></div>
              ) : (
                videos.map((video) => (
                  <div key={video.id} className="bg-white p-4 rounded-2xl border border-black/5 flex flex-col gap-2 shadow-sm">
                    <div className="flex items-start gap-4">
                      <img src={`https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg`} className="w-24 h-16 rounded-lg object-cover bg-gray-50" alt={video.title} />
                      <div className="flex-1">
                        <h4 className="font-serif text-lg text-olive-dark leading-tight mb-1">{video.title}</h4>
                        {video.category && <p className="text-xs text-olive/50 font-medium mb-1">{video.category}</p>}
                        <a href={`https://www.youtube.com/watch?v=${video.videoId}`} target="_blank" rel="noopener noreferrer" className="text-xs text-terracotta hover:underline">Poglej na YouTube</a>
                        <button onClick={() => startEditVideo(video)} className="inline-flex items-center gap-2 mt-2 px-3 py-1 text-xs font-semibold text-olive/90 bg-olive/10 border border-olive/10 rounded-xl shadow-sm hover:bg-olive/20 transition-colors">
                          <Pencil size={14} /> Uredi
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </>
          ) : (
            <div className={`bg-white rounded-3xl p-6 shadow-sm border border-black/5 ${!sanityToken ? 'opacity-50 pointer-events-none' : ''}`}>
              <div className="flex items-center gap-2 mb-6 text-olive/50 cursor-pointer" onClick={() => { setIsEditingVideo(false); setEditingVideoId(null); setVideoForm({ title: '', videoId: '', category: '' }); }}><ArrowLeft size={16} /><span className="text-xs font-bold uppercase">Nazaj</span></div>

              <h3 className="font-serif text-xl text-olive-dark mb-4">{editingVideoId ? 'Uredi Video' : 'Dodaj Video'}</h3>

              <div className="space-y-4">
                <input
                  type="text"
                  className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-terracotta"
                  value={videoForm.title}
                  onChange={e => setVideoForm({ ...videoForm, title: e.target.value })}
                  placeholder="Naslov videa"
                />

                <div>
                  <input
                    type="text"
                    className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-terracotta"
                    value={videoForm.videoId}
                    onChange={e => setVideoForm({ ...videoForm, videoId: e.target.value })}
                    placeholder="YouTube URL ali Video ID (npr. dQw4w9WgXcQ)"
                  />
                  <p className="text-xs text-olive/50 mt-1 px-2">Vnesite celoten YouTube URL ali samo 11-mestni video ID</p>
                </div>

                <input
                  type="text"
                  className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-terracotta"
                  value={videoForm.category}
                  onChange={e => setVideoForm({ ...videoForm, category: e.target.value })}
                  placeholder="Kategorija (neobvezno)"
                />

                <div className="flex gap-2 mt-6">
                  {editingVideoId && <button onClick={handleDeleteVideo} className="p-4 bg-red-50 text-red-500 rounded-xl"><Trash2 size={20} /></button>}
                  <button
                    onClick={handleSaveVideo}
                    disabled={isUploading}
                    className="flex-1 bg-olive text-white py-4 rounded-2xl font-bold uppercase tracking-widest shadow-lg hover:bg-olive-dark transition-all flex items-center justify-center gap-2"
                  >
                    {isUploading ? <RefreshCw className="animate-spin" /> : <Save size={16} />}
                    {editingVideoId ? 'Posodobi' : 'Dodaj'}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* --- GALLERY/SETTINGS/ORDERS TABS (Minified for space, keeping logic) --- */}
      {activeTab === 'gallery' && (
        <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
          <div className={`bg-white rounded-3xl p-6 shadow-sm border border-black/5 mb-6`}>
            <h3 className="font-serif text-xl text-olive-dark mb-4 flex items-center gap-2"><Upload size={20} /> Nalo≈æi fotografije</h3>
            <input type="file" ref={fileInputRef} onChange={handleFileSelect} className="hidden" accept="image/*" multiple />
            <button onClick={() => fileInputRef.current?.click()} className="w-full border-2 border-dashed border-olive/20 rounded-2xl p-8 flex flex-col items-center justify-center text-olive/60 hover:border-olive transition-all"><ImageIcon size={32} /><span className="mt-2 text-xs font-bold uppercase">Izberi slike</span></button>
          </div>
          {pendingUploads.length > 0 && <button onClick={handleUploadConfirm} className="w-full bg-olive text-white py-4 rounded-2xl font-bold uppercase shadow-lg hover:bg-olive-dark" disabled={isUploading}>Objavi</button>}
        </div>
      )}

      {activeTab === 'settings' && (
        <div className="flex-1 p-6 bg-gray-50">
          <div className="bg-white p-6 rounded-3xl border border-black/5 shadow-sm">
            <h3 className="font-serif text-lg text-olive-dark mb-4">API Konfiguracija</h3>
            <div className="relative mb-4">
              <input
                type={showToken ? "text" : "password"}
                value={sanityToken}
                onChange={(e) => setSanityToken(e.target.value)}
                placeholder="Vnesite Sanity API token"
                className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm"
              />
              <button onClick={() => setShowToken(!showToken)} className="absolute right-8 top-1/2 -translate-y-1/2 text-gray-400">{showToken ? <EyeOff size={16} /> : <Eye size={16} />}</button>
              <button
                onClick={async () => {
                  try {
                    const text = await navigator.clipboard.readText();
                    setSanityToken(text);
                    alert('Token prilepljen iz odlo≈æi≈°ƒça!');
                  } catch (err) {
                    alert('Napaka pri branju odlo≈æi≈°ƒça. Kopirajte token roƒçno.');
                  }
                }}
                className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                title="Prilepi iz odlo≈æi≈°ƒça"
              >
                üìÑ
              </button>
            </div>
            <div className="space-y-3">
              <button onClick={handleSaveToken} className="w-full py-3 bg-olive text-white rounded-xl text-xs font-bold uppercase">Shrani Povezavo</button>

              <div className="text-xs text-gray-600 bg-gray-50 p-3 rounded-xl">
                <div className="font-medium mb-1">Status povezave:</div>
                <div className="flex items-center gap-2">
                  <div className={`w-2 h-2 rounded-full ${localStorage.getItem('sanity_token') ? 'bg-green-500' : 'bg-red-500'}`}></div>
                  <span>{localStorage.getItem('sanity_token') ? 'Povezan' : 'Ni povezan'}</span>
                </div>
                {localStorage.getItem('sanity_token') && (
                  <div className="mt-2">
                    <button
                      onClick={() => {
                        const token = localStorage.getItem('sanity_token');
                        navigator.clipboard.writeText(token || '');
                        alert('Token kopiran v odlo≈æi≈°ƒçe!');
                      }}
                      className="text-blue-600 underline text-xs"
                    >
                      Kopiraj token za drug brskalnik
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* --- TAB NAVIGATION --- */}
      <div className="flex border-b border-olive/10 bg-white sticky top-0 z-20">
        <button onClick={() => setActiveTab('inventory')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'inventory' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><Package size={16} />Izdelki</button>
        <button onClick={() => setActiveTab('orders')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'orders' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><ClipboardList size={16} />Naroƒçila</button>
        <button onClick={() => setActiveTab('gallery')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'gallery' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><ImageIcon size={16} />Galerija</button>
        <button onClick={() => setActiveTab('news')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'news' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><FileText size={16} />Novice</button>
        <button onClick={() => setActiveTab('videos')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'videos' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><Video size={16} />Video</button>
        <button onClick={() => setActiveTab('settings')} className={`flex-1 min-w-[80px] py-4 text-xs font-bold uppercase tracking-widest flex flex-col md:flex-row items-center gap-2 transition-colors ${activeTab === 'settings' ? 'text-olive border-b-2 border-olive bg-olive/5' : 'text-olive/40'}`}><Settings size={16} />Nastavitve</button>
      </div>
    </div>
  </div>
);
};

export default AdminInventory;
